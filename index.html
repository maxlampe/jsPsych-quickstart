<!DOCTYPE html>
<html>
<head>
    <title>Paced Mentats: Expert Data Annotation</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="./questions.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="plugin-survey-slider.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body></body>
<script>

    var questions = [
        {
            "q_no": "1",
            "question": "What is the largest planet in our solar system?",
            "choice1": "Earth",
            "choice2": "Jupiter",
            "choice3": "Saturn",
            "choice4": "Mars"
        },
        {
            "q_no": "2",
            "question": "What is the boiling point of water?",
            "choice1": "90째C",
            "choice2": "100째C",
            "choice3": "110째C",
            "choice4": "120째C"
        },
        {
            "q_no": "3",
            "question": "Who wrote 'Romeo and Juliet'?",
            "choice1": "Mark Twain",
            "choice2": "Charles Dickens",
            "choice3": "William Shakespeare",
            "choice4": "Jane Austen"
        },
    ];

    function saveData(data) {
        const url = 'https://script.google.com/macros/s/AKfycbyP7iMI5MlFnTtVgmJjzHkgx1cBr5d6NYR-jjghBmCKketxDQtIvRMxtNhyCgA40e6bfQ/exec';
        const payload = JSON.stringify(data);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: payload,
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

    var jsPsych = initJsPsych({
        on_finish: function () {
            const data = jsPsych.data.get().csv();
            saveData(data);
        },
        show_progress_bar: true,
    });

    var timeline = [];

    const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <p><b>Welcome</b> to the 'Paced Mentats: Expert Data Annotation' process.</p>
            <p><b>Thank you so much</b> for taking the time and sharing your valuable expertise! We are excited and happy to have you on the team!</p>
            <p>You are accessing version v0.1 (05/17/2024)</p>
            <p>Press any key to begin.</p>
        `
    };
    timeline.push(welcome);

    const participantInfo = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <p>Please enter your first name:</p>
            <input type="text" id="participant-name" name="participant-name">
            <p>Please enter your given unique rater ID (UID):</p>
            <input type="text" id="rater-id" name="rater-id">
            <button onclick="jsPsych.finishTrial({ 
                participant_name: document.getElementById('participant-name').value, 
                rater_id: document.getElementById('rater-id').value 
            })">Submit</button>
            <p>\n\n<h2>Instructions</h2>\n
            In the following survey, you will be shown one question at a time with a set of possible answers. </p>
            <p><b>Please take your time to read each question and all the answers carefully</b>.</p>
            <p><b>Move the sliders</b> for each answer option to <b>indicate how confident you are</b> that the answer is a correct response to the question.</p>
            <p>\nIf you are certain that the answer is a <b>correct joice for the question</b>, move the slide <b>all the way to the right</b>.</p>
            <p>\nIf you are certain that the answer is an <b>incorrect joice for the question</b>, move the slide <b>all the way to the left</b>.</p>
            <p>Multiple answers can be correct, incorrect, or somewhere in the between.</p>
            <p>If you think there is an issue with the quesiton or one of the answers, please use the text box under each question to share your thoughts.</p>
        `,
        choices: "NO_KEYS",
        on_load: function() {
            document.querySelector('button').addEventListener('click', function() {
                jsPsych.finishTrial({
                    participant_name: document.getElementById('participant-name').value,
                    rater_id: document.getElementById('rater-id').value
                });
            });
        }
    };
    timeline.push(participantInfo);

    function createSurvey(questionData) {
        function getRandomSliderStart() {
            return Math.floor(Math.random() * 101); // Generates a random integer between 0 and 100
        }

        return {
            type: jsPsychSurveySlider,
            preamble: "<p>Q" + questionData.q_no + ": " + questionData.question + "</p>", 
            questions: [
                {prompt: questionData.choice1, ticks:['0','100'], slider_start: getRandomSliderStart()},
                {prompt: questionData.choice2, ticks:['0','100'], slider_start: getRandomSliderStart()},
                {prompt: questionData.choice3, ticks:['0','100'], slider_start: getRandomSliderStart()},
                {prompt: questionData.choice4, ticks:['0','100'], slider_start: getRandomSliderStart()},
            ],
            post_trial_gap: 1000,
            randomize_question_order: true,
            require_movement: true,
            slider_width: 200,
            data: { q_no: questionData.q_no, q: questionData.question }, 
        };
    }

    var sampledQuestions = questions.sort(() => 0.5 - Math.random()).slice(0, 3);

    sampledQuestions.forEach(function(question) {
        var survey = createSurvey(question);
        timeline.push(survey);
    });

    jsPsych.run(timeline);

</script>
</html>
